<script type="text/javascript">
  function Promise(fn) {
    var state = 'pending';
    var value;
    var deferred = null;

    function resolve(newValue) {
      //4
      value = newValue;
      state = 'resolved';

      if(deferred) {
        handle(deferred);
      }
    }

    function handle(handler) {
      if(state === 'pending') {
        deferred = handler;
        return;
      }

      if(!handler.onResolved) {
        handler.resolve(value);
        return;
      }

      var ret = handler.onResolved(value);
      handler.resolve(ret);
    }

    this.then = function(onResolved) {
      return new Promise(function(resolve) {
        handle({
          onResolved: onResolved,
          resolve: resolve
        });
      });
    };
    //2
    fn(resolve);
}

function doSomething() {
  //1
    return new Promise(function(resolve) {
        //3
        var value = 42;
        resolve(value);
    });
}

doSomething().then(function(firstResult) {
    document.writeln("first result ", firstResult);
    return 88;
}).then(function(secondResult) {
    document.writeln("second result ", secondResult);
});

</script>